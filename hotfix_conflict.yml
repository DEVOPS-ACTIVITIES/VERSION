stages:
  - deploy

# Job to automatically sync hotfix changes from main branch to environment branches
sync-environment-branches:
  stage: deploy
  image: alpine:latest
  variables:
    GIT_DEPTH: 0  # Full clone needed for merge operations
    # Define your target environment branches (in reverse order of workflow)
    TARGET_BRANCHES: "qa test dev feature"
  script:
    # Install git and required tools
    - apk add --no-cache git
    
    # Configure git user
    - git config --global user.email "$GITLAB_USER_EMAIL"
    - git config --global user.name "$GITLAB_USER_NAME"
    
    # Set up authentication for pushing
    - git remote set-url origin "https://oauth2:${SYNC_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
    
    # Fetch all branches
    - git fetch origin
    
    # Create directory for conflict reports
    - mkdir -p conflict-reports
    
    # Sync each environment branch with main
    - |
      echo "=========================================="
      echo "Starting automatic hotfix sync process"
      echo "Source: $CI_DEFAULT_BRANCH"
      echo "Targets: $TARGET_BRANCHES"
      echo "=========================================="
      
      FAILED_BRANCHES=""
      CONFLICT_BRANCHES=""
      HAS_CONFLICTS=false
      
      for branch in $TARGET_BRANCHES; do
        echo ""
        echo "------------------------------------------------"
        echo "Processing branch: $branch"
        echo "------------------------------------------------"
        
        # Check if branch exists on remote
        if ! git ls-remote --heads origin $branch | grep -q $branch; then
          echo "⚠️  Skip: Branch '$branch' does not exist on remote"
          continue
        fi
        
        # Checkout the target branch
        if git checkout -B "$branch" "origin/$branch"; then
          echo "✓ Checked out $branch"
          
          # First, try merge without auto-resolution to detect conflicts
          echo "Attempting merge to detect conflicts..."
          if git merge "origin/$CI_DEFAULT_BRANCH" --no-commit --no-ff 2>&1; then
            echo "✓ No conflicts detected"
            # Complete the merge
            git commit --no-edit -m "Merge $CI_DEFAULT_BRANCH into $branch"
            
            # Push changes (skip CI to prevent recursive triggers)
            if git push origin "$branch" -o ci.skip; then
              echo "✅ Successfully synced $branch with $CI_DEFAULT_BRANCH"
            else
              echo "❌ Failed to push $branch"
              FAILED_BRANCHES="$FAILED_BRANCHES $branch"
            fi
          else
            echo "⚠️  Conflicts detected on $branch"
            HAS_CONFLICTS=true
            CONFLICT_BRANCHES="$CONFLICT_BRANCHES $branch"
            
            # Create conflict report file
            REPORT_FILE="conflict-reports/${branch}-conflicts.txt"
            echo "=============================================" > "$REPORT_FILE"
            echo "  CONFLICT REPORT: $branch branch" >> "$REPORT_FILE"
            echo "=============================================" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo "Merged from: $CI_DEFAULT_BRANCH" >> "$REPORT_FILE"
            echo "Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo "RESOLUTION: Conflicts were AUTO-RESOLVED" >> "$REPORT_FILE"
            echo "            Main branch changes were kept" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo "=============================================" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            
            # Count conflicted files
            CONFLICT_COUNT=$(git diff --name-only --diff-filter=U | wc -l)
            echo "Total files with conflicts: $CONFLICT_COUNT" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            
            # List each conflicted file with line numbers and conflict details
            for conflicted_file in $(git diff --name-only --diff-filter=U); do
              echo "---------------------------------------------" >> "$REPORT_FILE"
              echo "File: $conflicted_file" >> "$REPORT_FILE"
              echo "---------------------------------------------" >> "$REPORT_FILE"
              
              # Extract conflict markers with line numbers
              CONFLICT_LINES=$(grep -n "^<<<<<<< HEAD" "$conflicted_file" 2>/dev/null | cut -d: -f1 | tr '\n' ', ' | sed 's/,$//')
              
              if [ -n "$CONFLICT_LINES" ]; then
                echo "Conflicts found at line(s): $CONFLICT_LINES" >> "$REPORT_FILE"
                echo "" >> "$REPORT_FILE"
                echo "What happened:" >> "$REPORT_FILE"
                echo "- Your $branch branch had different code at these lines" >> "$REPORT_FILE"
                echo "- The main branch (hotfix) had different code" >> "$REPORT_FILE"
                echo "- AUTO-RESOLVED: Main branch version was used" >> "$REPORT_FILE"
                echo "" >> "$REPORT_FILE"
                echo "Conflicting sections:" >> "$REPORT_FILE"
                echo "" >> "$REPORT_FILE"
                
                # Show the actual conflict diff for better understanding
                git diff "$conflicted_file" 2>/dev/null | head -100 >> "$REPORT_FILE" || echo "Unable to display diff" >> "$REPORT_FILE"
              else
                echo "Conflicts detected but markers not readable" >> "$REPORT_FILE"
              fi
              echo "" >> "$REPORT_FILE"
            done
            
            echo "=============================================" >> "$REPORT_FILE"
            echo "RECOMMENDED ACTION:" >> "$REPORT_FILE"
            echo "Review the files listed above and verify the" >> "$REPORT_FILE"
            echo "changes are correct for your branch." >> "$REPORT_FILE"
            echo "=============================================" >> "$REPORT_FILE"
            
            # Display summary to console
            echo "Conflict details saved to: $REPORT_FILE"
            echo "Conflicted files:"
            git diff --name-only --diff-filter=U
            
            # Abort the conflicted merge
            git merge --abort
            
            # Now merge with -X theirs to auto-resolve conflicts
            echo "Auto-resolving conflicts using '-X theirs' strategy..."
            if git merge "origin/$CI_DEFAULT_BRANCH" --no-edit -X theirs; then
              echo "✓ Merged $CI_DEFAULT_BRANCH into $branch (conflicts auto-resolved)"
              
              # Push changes (skip CI to prevent recursive triggers)
              if git push origin "$branch" -o ci.skip; then
                echo "⚠️  Successfully synced $branch with $CI_DEFAULT_BRANCH (with auto-resolved conflicts)"
              else
                echo "❌ Failed to push $branch"
                FAILED_BRANCHES="$FAILED_BRANCHES $branch"
              fi
            else
              echo "❌ Merge failed even with -X theirs on $branch"
              git merge --abort
              FAILED_BRANCHES="$FAILED_BRANCHES $branch"
            fi
          fi
        else
          echo "❌ Failed to checkout $branch"
          FAILED_BRANCHES="$FAILED_BRANCHES $branch"
        fi
      done
      
      echo ""
      echo "=========================================="
      echo "Sync process completed"
      echo "=========================================="
      
      # Generate summary report
      SUMMARY_FILE="conflict-reports/summary.txt"
      echo "=============================================" > "$SUMMARY_FILE"
      echo "  HOTFIX SYNC SUMMARY" >> "$SUMMARY_FILE"
      echo "=============================================" >> "$SUMMARY_FILE"
      echo "" >> "$SUMMARY_FILE"
      echo "Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> "$SUMMARY_FILE"
      echo "Synced from: $CI_DEFAULT_BRANCH" >> "$SUMMARY_FILE"
      echo "Synced to: $TARGET_BRANCHES" >> "$SUMMARY_FILE"
      echo "" >> "$SUMMARY_FILE"
      
      if [ "$HAS_CONFLICTS" = true ]; then
        echo "STATUS: ⚠️  CONFLICTS AUTO-RESOLVED" >> "$SUMMARY_FILE"
        echo "" >> "$SUMMARY_FILE"
        echo "Branches with conflicts:$CONFLICT_BRANCHES" >> "$SUMMARY_FILE"
        echo "" >> "$SUMMARY_FILE"
        echo "What this means:" >> "$SUMMARY_FILE"
        echo "- Some files had different changes in both branches" >> "$SUMMARY_FILE"
        echo "- The conflicts were automatically resolved" >> "$SUMMARY_FILE"
        echo "- Main branch (hotfix) changes were kept" >> "$SUMMARY_FILE"
        echo "" >> "$SUMMARY_FILE"
        echo "ACTION REQUIRED:" >> "$SUMMARY_FILE"
        echo "Check the detailed reports for each branch above" >> "$SUMMARY_FILE"
        echo "to see which files were affected." >> "$SUMMARY_FILE"
        echo "" >> "$SUMMARY_FILE"
      fi
      
      if [ -n "$FAILED_BRANCHES" ]; then
        echo "STATUS: ❌ SOME BRANCHES FAILED" >> "$SUMMARY_FILE"
        echo "" >> "$SUMMARY_FILE"
        echo "Failed branches:$FAILED_BRANCHES" >> "$SUMMARY_FILE"
        echo "" >> "$SUMMARY_FILE"
        echo "ACTION REQUIRED:" >> "$SUMMARY_FILE"
        echo "These branches need manual review and sync." >> "$SUMMARY_FILE"
        echo "" >> "$SUMMARY_FILE"
      fi
      
      if [ "$HAS_CONFLICTS" = false ] && [ -z "$FAILED_BRANCHES" ]; then
        echo "STATUS: ✅ ALL SYNCED SUCCESSFULLY" >> "$SUMMARY_FILE"
        echo "" >> "$SUMMARY_FILE"
        echo "No conflicts were detected." >> "$SUMMARY_FILE"
        echo "All branches are up to date with main." >> "$SUMMARY_FILE"
        echo "" >> "$SUMMARY_FILE"
      fi
      
      echo "=============================================" >> "$SUMMARY_FILE"
      
      # Display summary
      cat "$SUMMARY_FILE"
      
      if [ -n "$FAILED_BRANCHES" ]; then
        echo "⚠️  Branches that failed to sync:$FAILED_BRANCHES"
        echo "Please review and sync these branches manually"
        exit 1
      elif [ "$HAS_CONFLICTS" = true ]; then
        echo "⚠️  Job completed with conflicts (auto-resolved)"
        echo "Please review conflict reports in artifacts"
        # Exit with code 1 to mark as warning (allow_failure will prevent pipeline failure)
        exit 1
      else
        echo "✅ All branches synced successfully without conflicts"
      fi
      
  # Store conflict reports as artifacts
  artifacts:
    name: "conflict-reports-$CI_COMMIT_SHORT_SHA"
    paths:
      - conflict-reports/
    when: always
    expire_in: 30 days
  
  # Allow job to show warning when conflicts are auto-resolved
  # Job exits with code 1 for conflicts, but pipeline continues
  allow_failure: true
  
  # Trigger rules
  rules:
    # Automatically trigger when a hotfix branch is merged to main
    # Matches: "Merge branch 'hotfix/..." or "Merge branch 'hotfix-..." or "Merge branch 'hotfix..."
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_COMMIT_TITLE =~ /Merge.*['\"]hotfix/
      when: always
    
    # Allow manual triggering from GitLab Web UI
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
    
    # Don't run for any other case
    - when: never
